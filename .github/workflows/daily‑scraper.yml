name: ğŸ¤– Daily Resource Scraper

on:
  schedule:
    # Run daily at 9:00 AM UTC (2:00 PM Pakistan Time)
    - cron: '0 9 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (limited resources)'
        required: false
        default: 'false'
        type: boolean

jobs:
  scrape-resources:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
    
    - name: ğŸ”‘ Create Firebase Service Account File
      run: |
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > scripts/firebase-key.json
    
    - name: ğŸš€ Run Automation Scraper
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
      run: |
        cd scripts
        python auto_scraper.py
    
    - name: ğŸ§¹ Cleanup Sensitive Files
      if: always()
      run: |
        rm -f scripts/firebase-key.json
    
    - name: ğŸ“Š Upload Logs (if failed)
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: scraper-logs
        path: scripts/*.log
        retention-days: 7

  # Notify on failure
  notify-failure:
    runs-on: ubuntu-latest
    needs: scrape-resources
    if: failure()
    
    steps:
    - name: ğŸš¨ Send Failure Notification
      run: |
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "content": "ğŸš¨ **Freezy Platform Scraper Failed!**\n\nâŒ The daily scraping job encountered an error.\nğŸ”— Check the logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nâ° Time: '"$(date)"'",
          "username": "Freezy Alert Bot",
          "avatar_url": "https://cdn-icons-png.flaticon.com/512/564/564619.png"
        }'
